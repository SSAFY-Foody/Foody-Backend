<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.foody.food.mapper.FoodMapper">
	<resultMap id="foodResultMap" type="Food">
		<id column="code" property="code" />

		<result column="name" property="name" />
		<result column="category" property="category" />
		<result column="standard" property="standard" />
		<result column="kcal" property="kcal" />

		<result column="carb_g" property="carb" />
		<result column="protein_g" property="protein" />
		<result column="fat_g" property="fat" />
		<result column="sugar_g" property="sugar" />
		<result column="natrium_g" property="natrium" />
	</resultMap>

    <resultMap id="favoriteCodeMap" type="com.ssafy.foody.food.dto.FavoriteCodeResponse">
        <id column="favoriteId" property="favoriteId"/>
        <result column="foodCode" property="foodCode"/>
        <result column="userFoodCode" property="userFoodCode"/>
    </resultMap>

	<select id="selectFoodList" resultMap="foodResultMap">
		SELECT
		code, name, category, standard, kcal,
		carb_g,
		protein_g,
		fat_g,
		sugar_g,
		natrium_g
		FROM foods

		<where>
			<if test="keyword != null and keyword != ''">
				AND name LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test="category != null and category != ''">
				AND category LIKE CONCAT('%', #{category}, '%')
			</if>
		</where>

		ORDER BY name ASC

		LIMIT #{limit} OFFSET #{offset}

	</select>

	<!-- 음식 개수 조회 (페이지네이션용) -->
	<select id="countFoodList" resultType="int">
		SELECT COUNT(*)
		FROM foods
		<where>
			<if test="keyword != null and keyword != ''">
				AND name LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test="category != null and category != ''">
				AND category LIKE CONCAT('%', #{category}, '%')
			</if>
		</where>
	</select>

	<select id="findFoodByCode" resultMap="foodResultMap">
		SELECT
		code, name, category, standard, kcal,
		carb_g, protein_g, fat_g, sugar_g, natrium_g
		FROM foods
		WHERE code = #{code}
	</select>

	<insert id="saveUserFood"
		parameterType="UserFood"
		useGeneratedKeys="true" keyProperty="code">
		INSERT INTO user_foods (
		regist_user_id, name, standard,
		kcal, carb_g, protein_g, fat_g, sugar_g, natrium_g,
		created_at
		) VALUES (
		#{registUserId}, #{name}, #{standard},
		#{kcal}, #{carb}, #{protein}, #{fat}, #{sugar}, #{natrium},
		NOW()
		)
	</insert>
	
    <insert id="insertFavorite" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO favorites (user_id, food_code, user_food_code)
        VALUES (
            #{userId}, 
            #{foodCode}, #{userFoodCode} )
    </insert>
    
    <delete id="deleteFavorite">
        DELETE FROM favorites WHERE id = #{favoriteId}
    </delete>
    
    <select id="checkFavoriteExists" resultType="Integer">
        SELECT id FROM favorites
        WHERE user_id = #{userId}
        <if test="foodCode != null"> AND food_code = #{foodCode} </if>
        <if test="userFoodCode != null"> AND user_food_code = #{userFoodCode} </if>
        LIMIT 1
    </select>
    
    <select id="selectFavoriteList" resultType="FavoriteResponse">
        SELECT 
            fav.id AS favoriteId,
            fav.food_code AS foodCode,
            fav.user_food_code AS userFoodCode,
            COALESCE(f.name, uf.name) as name,
            COALESCE(f.standard, uf.standard) as standard,
            COALESCE(f.kcal, uf.kcal) as kcal,
            COALESCE(f.carb_g, uf.carb_g) as carb,
            COALESCE(f.protein_g, uf.protein_g) as protein,
            COALESCE(f.fat_g, uf.fat_g) as fat,
            COALESCE(f.sugar_g, uf.sugar_g) as sugar,
            COALESCE(f.natrium_g, uf.natrium_g) as natrium
        FROM favorites fav
        LEFT JOIN foods f ON fav.food_code = f.code
        LEFT JOIN user_foods uf ON fav.user_food_code = uf.code
        WHERE fav.user_id = #{userId}
        <if test='filter == "GENERAL"'>
            AND fav.user_food_code IS NULL
        </if>
        <if test='filter == "CUSTOM"'>
            AND fav.user_food_code IS NOT NULL
        </if>
        ORDER BY fav.id DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    
    <select id="countFavoriteList" resultType="int">
        SELECT COUNT(*)
        FROM favorites
        WHERE user_id = #{userId}
        <if test='filter == "GENERAL"'>
            AND user_food_code IS NULL
        </if>
        <if test='filter == "CUSTOM"'>
            AND user_food_code IS NOT NULL
        </if>
    </select>
    
    <insert id="addFood">
    	INSERT INTO foods(code, name, category, standard, kcal, carb_g, protein_g, fat_g, sugar_g, natrium_g)
    	VALUES (
    	#{code}, #{name}, #{category}, #{standard}, #{kcal}
    	, #{carb}, #{protein}, #{fat}, #{sugar}, #{natrium})
    </insert>
    
    <delete id="deleteFoodByCode">
    	DELETE FROM foods
    	WHERE code = #{code}
    </delete>
    
    <select id="selectDistinctCategories" resultType="String">
        SELECT DISTINCT category
        FROM foods
        WHERE category IS NOT NULL AND category != ''
        ORDER BY category ASC
    </select>

    <select id="selectUserFoodList" resultMap="foodResultMap">
        SELECT 
            CAST(code AS CHAR) as code,
            name, 
            '직접 입력' as category, 
            standard, 
            kcal,
            carb_g, 
            protein_g, 
            fat_g, 
            sugar_g, 
            natrium_g
        FROM user_foods
        WHERE regist_user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    
    <select id="countUserFoodList" resultType="int">
        SELECT COUNT(*)
        FROM user_foods
        WHERE regist_user_id = #{userId}
    </select>

    <select id="selectAllFavoriteCodes" resultMap="favoriteCodeMap">
        SELECT id as favoriteId, food_code as foodCode, user_food_code as userFoodCode
        FROM favorites
        WHERE user_id = #{userId}
    </select>

</mapper>