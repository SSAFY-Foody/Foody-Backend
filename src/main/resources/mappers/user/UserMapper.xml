<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.foody.user.mapper.UserMapper">

	<insert id="save" parameterType="User">
		INSERT INTO users (
		id,
		password,
		name,
		age,
		email,
		height,
		weight,
		gender,
		activity_level,
		is_diabetes,
		role,
		provider,
		provider_id,
		created_at
		) VALUES (
		#{id},
		#{password},
		#{name},
		#{age},
		#{email},
		#{height},
		#{weight},
		#{gender},
		#{activityLevel},
		#{isDiabetes},
		#{role},
		#{provider},
		#{providerId},
		NOW()
		)
	</insert>

	<update id="updateUser" parameterType="User">
		UPDATE users
		<set>
			<if test="name != null">name = #{name},</if>
			<if test="password != null">password = #{password},</if>
			<if test="age != 0">age = #{age},</if>
			<if test="height != 0">height = #{height},</if>
			<if test="weight != 0">weight = #{weight},</if>
			<if test="gender != null">gender = #{gender},</if>
			<if test="activityLevel != null">activity_level = #{activityLevel},</if>
			<if test="isDiabetes != null">is_diabetes = #{isDiabetes},</if>
			<if test="role != null">role = #{role},</if>
		</set>
		WHERE id = #{id}
	</update>

	<delete id="deleteUser" parameterType="string">
		DELETE FROM users WHERE id = #{id}
	</delete>

	<select id="findById" resultType="User">
		SELECT
		id, password, name as
		name, age, email, height, weight,
		gender, activity_level, is_diabetes,
		role, provider, provider_id, created_at
		FROM users
		WHERE id = #{id}
	</select>

	<select id="findByProviderId" resultType="User">
		SELECT
		id, password,
		name as name, age, email, height, weight,
		gender, activity_level,
		is_diabetes, role, provider, provider_id, created_at
		FROM users
		WHERE
		provider_id = #{providerId}
	</select>

	<select id="existsById" resultType="boolean">
		SELECT EXISTS (SELECT 1 FROM
		users WHERE id = #{id})
	</select>

	<insert id="insertStdInfo" parameterType="StdInfo">
		INSERT INTO std_infos (
		user_id,
		std_weight,
		std_kcal,
		std_carb_g,
		std_protein_g,
		std_fat_g,
		std_sugar_g,
		std_natrium_g
		) VALUES (
		#{userId},
		#{stdWeight},
		#{stdKcal},
		#{stdCarb},
		#{stdProtein},
		#{stdFat},
		#{stdSugar},
		#{stdNatrium}
		)
	</insert>

	<update id="updateStdInfo" parameterType="StdInfo">
		UPDATE std_infos
		<set>
			<if test="stdWeight != 0">std_weight = #{stdWeight},</if>
			<if test="stdKcal != 0">std_kcal = #{stdKcal},</if>
			<if test="stdCarb != 0">std_carb_g = #{stdCarb},</if>
			<if test="stdProtein != 0">std_protein_g = #{stdProtein},</if>
			<if test="stdFat != 0">std_fat_g = #{stdFat},</if>
			<if test="stdSugar != 0">std_sugar_g = #{stdSugar},</if>
			<if test="stdNatrium != 0">std_natrium_g = #{stdNatrium},</if>
		</set>
		WHERE user_id = #{userId}
	</update>

	<select id="getActivityValue" parameterType="int"
		resultType="double">
		SELECT
		value
		FROM activity_levels
		WHERE
		level = #{level}
	</select>

	<resultMap id="userWithStdInfoMap" type="User">
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="age" column="age" />
		<result property="email" column="email" />
		<result property="height" column="height" />
		<result property="weight" column="weight" />
		<result property="gender" column="gender" />
		<result property="activityLevel" column="activity_level" />
		<result property="isDiabetes" column="is_diabetes" />
		<result property="role" column="role" />
		<result property="provider" column="provider" />
		<result property="providerId" column="provider_id" />
		<result property="createdAt" column="created_at" />
		
		<association property="stdInfo" javaType="StdInfo"
			notNullColumn="std_kcal">
			<id property="userId" column="user_id" />
			<result property="stdWeight" column="std_weight" />
			<result property="stdKcal" column="std_kcal" />
			<result property="stdCarb" column="std_carb_g" />
			<result property="stdProtein" column="std_protein_g" />
			<result property="stdFat" column="std_fat_g" />
			<result property="stdSugar" column="std_sugar_g" />
			<result property="stdNatrium" column="std_natrium_g" />
		</association>
	</resultMap>

	<!-- 표준 정보가 없더라도 가져오게끔 LEFT JOIN -->
	<select id="findUserWithStdInfo" resultMap="userWithStdInfoMap">
		SELECT
		u.id,
		u.password,
		u.name,
		u.age,
		u.email,
		u.height,
		u.weight,
		u.gender,
		u.activity_level,
		u.is_diabetes,
		u.role,
		u.provider,
		u.provider_id,
		u.created_at,
		s.std_weight,
		s.std_kcal,
		s.std_carb_g,
		s.std_protein_g,
		s.std_fat_g,
		s.std_sugar_g,
		s.std_natrium_g
		FROM users u
		LEFT JOIN std_infos s ON u.id = s.user_id
		WHERE u.id = #{userId}
	</select>

</mapper>